name: Mission JSON Validate

on:
  push:
    paths:
      - 'src/**'
      - 'schemas/**'
      - '.github/workflows/mission-validate.yml'
  pull_request:

jobs:
  mission-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt jsonschema
      - name: FTL analysis timestamp
        run: echo "FTL analysis timestamp: 2025-08-14 15:14 PDT"
      - name: Run tiny mission and export JSON + perf CSV
        run: |
          python -m impulse.mission_cli --waypoints examples/waypoints/simple.json --export mission.json --perf-csv perf.csv --hybrid simulate-first
      - name: Validate mission.json against schema
        run: |
          python bin/validate_mission_json.py mission.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mission-export
          path: |
            mission.json
            perf.csv

  perf-aggregate:
    needs: mission-validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
      - name: Download perf.csv artifact
        uses: actions/download-artifact@v4
        with:
          name: mission-export
          path: ./artifacts
      - name: Plot perf summary
        run: |
          python bin/plot_perf_csv.py --csv ./artifacts/perf.csv --out perf_summary.png
      - name: Aggregate perf summary JSON
        run: |
          # Simulate multiple runs if only one CSV is present
          cp ./artifacts/perf.csv ./artifacts/perf_run2.csv
          python bin/aggregate_perf_csv.py ./artifacts/perf.csv ./artifacts/perf_run2.csv --out perf_aggregate.json
      - name: 40 Eridani A UQ + analysis (100 samples)
        run: |
          python -m src.uq_validation.impulse_uq_runner --samples 100 --seed 123 --out uq_summary.json --jsonl-out uq_records.jsonl --dist-profile data/dist_profile_40eridani.csv
          # Generate plots from notebook logic with plain Python (no execution needed beyond plotting utilities already used)
          python - << 'PY'
import json
from pathlib import Path
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np
records = []
if Path('uq_records.jsonl').exists():
    for line in Path('uq_records.jsonl').read_text().splitlines():
        if line.strip():
            records.append(json.loads(line))
energies = [r.get('planned_energy', 0) for r in records]
if energies:
    plt.figure(figsize=(6,4))
    plt.hist(energies, bins=15, color='#4C78A8', edgecolor='white')
    plt.title('Planned Energy Distribution')
    plt.xlabel('Energy (J)')
    plt.ylabel('Count')
    plt.tight_layout()
    plt.savefig('40eridani_energy.png', dpi=150)
feas = [1 if r.get('feasible') else 0 for r in records]
if feas:
    n = len(feas)
    win = max(1, n//10)
    roll = np.convolve(feas, np.ones(win)/win, mode='same')
    plt.figure(figsize=(6,4))
    plt.plot(roll, color='#F58518')
    plt.ylim(0,1)
    plt.title('Feasible Fraction (rolling)')
    plt.xlabel('Sample Index')
    plt.ylabel('Feasible Fraction')
    plt.tight_layout()
    plt.savefig('40eridani_feasibility.png', dpi=150)
PY
      - name: Generate extended 40 Eridani plots
        run: |
          python - << 'PY'
import json
from pathlib import Path
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np
records = []
if Path('uq_records.jsonl').exists():
    for line in Path('uq_records.jsonl').read_text().splitlines():
      if line.strip():
        records.append(json.loads(line))
energies = [r.get('planned_energy', 0) for r in records]
if energies:
    plt.figure(figsize=(6,4))
    plt.hist(energies, bins=30, color='#4C78A8', edgecolor='white')
    plt.title('Planned Energy Distribution (Extended)')
    plt.xlabel('Energy (J)')
    plt.ylabel('Count')
    plt.tight_layout()
    plt.savefig('40eridani_energy_extended.png', dpi=150)
feas = [1 if r.get('feasible') else 0 for r in records]
if feas:
    n = len(feas)
    win = max(1, n//5)
    roll = np.convolve(feas, np.ones(win)/win, mode='same')
    plt.figure(figsize=(6,4))
    plt.plot(roll, color='#F58518')
    plt.ylim(0,1)
    plt.title('Feasible Fraction (rolling, Extended)')
    plt.xlabel('Sample Index')
    plt.ylabel('Feasible Fraction')
    plt.tight_layout()
    plt.savefig('40eridani_feasibility_extended.png', dpi=150)
PY
      - name: 40 Eridani A UQ with varied distance profile (100 samples)
        run: |
          python -m src.uq_validation.impulse_uq_runner --samples 100 --seed 123 --out uq_summary_varied.json --jsonl-out uq_records_varied.jsonl --dist-profile data/dist_profile_40eridani_varied.csv
          python - << 'PY'
import json
from pathlib import Path
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np
records = []
if Path('uq_records_varied.jsonl').exists():
    for line in Path('uq_records_varied.jsonl').read_text().splitlines():
        if line.strip():
            records.append(json.loads(line))
energies = [r.get('planned_energy', 0) for r in records]
if energies:
    plt.figure(figsize=(6,4))
    plt.hist(energies, bins=20, color='#54A24B', edgecolor='white')
    plt.title('Planned Energy Distribution (Varied Profile)')
    plt.xlabel('Energy (J)')
    plt.ylabel('Count')
    plt.tight_layout()
    plt.savefig('40eridani_energy_varied.png', dpi=150)
feas = [1 if r.get('feasible') else 0 for r in records]
if feas:
    n = len(feas)
    win = max(1, n//10)
    roll = np.convolve(feas, np.ones(win)/win, mode='same')
    plt.figure(figsize=(6,4))
    plt.plot(roll, color='#E45756')
    plt.ylim(0,1)
    plt.title('Feasible Fraction (rolling, Varied Profile)')
    plt.xlabel('Sample Index')
    plt.ylabel('Feasible Fraction')
    plt.tight_layout()
    plt.savefig('40eridani_feasibility_varied.png', dpi=150)
# Save simple metrics for verification
energy_mean = float(np.mean(energies)) if energies else float('nan')
energy_std = float(np.std(energies)) if energies else float('nan')
energy_cv = float(energy_std/energy_mean) if energies and energy_mean else float('nan')
feasible_fraction = float(np.mean(feas)) if feas else float('nan')
with open('uq_varied_metrics.json', 'w') as f:
  json.dump({"energy_mean": energy_mean, "energy_std": energy_std, "energy_cv": energy_cv, "feasible_fraction": feasible_fraction}, f)
PY
      - name: Validate varied profile metrics against thresholds
        run: |
          echo "Validating varied profile metrics: 2025-08-14 15:53 PDT"
          python - << 'PY'
import json
with open('uq_varied_metrics.json','r') as f:
    d = json.load(f)
cv = float(d.get('energy_cv', 1.0))
ff = float(d.get('feasible_fraction', 0.0))
assert cv < 0.05, f"Energy CV too high: {cv}"
assert ff > 0.9, f"Feasible fraction too low: {ff}"
print('Varied profile gates passed:', {'energy_cv': cv, 'feasible_fraction': ff})
PY
      - name: Upload perf summary
        uses: actions/upload-artifact@v4
        with:
          name: perf-summary
          path: perf_summary.png
      - name: Upload 40 Eridani artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 40eridani-artifacts
          path: |
            uq_summary.json
            uq_records.jsonl
            perf_aggregate.json
            40eridani_energy.png
            40eridani_feasibility.png
            40eridani_energy_extended.png
            40eridani_feasibility_extended.png
            uq_summary_varied.json
            uq_records_varied.jsonl
            40eridani_energy_varied.png
            40eridani_feasibility_varied.png
            uq_varied_metrics.json
      - name: Comment summary on PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Posting PR summary..."
          ENERGY=$(jq -r '.segment_energy_mean' perf_aggregate.json)
          TIME=$(jq -r '.segment_time_mean' perf_aggregate.json)
          FEAS=$(jq -r '.feasible_fraction // empty' uq_summary.json 2>/dev/null || echo "")
          BODY="Perf Aggregate Summary:%0A- Mean Segment Energy: ${ENERGY} J%0A- Mean Segment Time: ${TIME} s%0A- Feasible Fraction (UQ): ${FEAS}"
          gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
